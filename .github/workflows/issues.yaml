---
name: Create JIRA ticket for new issues

on:
  issues:
    types: [opened]

jobs:
  jira_task:
    name: Create Jira issue
    runs-on: ubuntu-latest
    steps:
    - name: Create JIRA ticket
      id: create
      shell: bash
      env:
        ISSUE_TITLE: ${{ github.event.issue.title }}
        ISSUE_BODY: ${{ github.event.issue.body }}
        ISSUE_URL: ${{ github.event.issue.html_url }}
        JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      run: |
        json_response=$(curl --request POST \
          --url 'https://jira.mongodb.org/rest/api/2/issue' \
          --header 'Authorization: Bearer '"${JIRA_API_TOKEN}" \
          --header 'Accept: application/json' \
          --header 'Content-Type: application/json' \
          --data '{
            "fields": {
                "project": {
                    "id": "19383"
                },
                "summary": "HELP: '"${ISSUE_TITLE}"'",
                "issuetype": {
                    "id": "3"
                },
                "description": "This ticket track the following GitHub issue: '"${ISSUE_URL}"'\n\n Description:\n'"${ISSUE_BODY}"'",
                "components": [
                    {
                        "id": "32225"
                    }
                ]
            }
          }')

        JIRA_TICKET_ID=$(echo "${json_response}" | jq -r '.key')
        echo "The following JIRA ticket has been created: ${JIRA_TICKET_ID}"
        echo "jira-ticket-id=${JIRA_TICKET_ID}" >> "${GITHUB_OUTPUT}"
    - name: Add comment
      uses: peter-evans/create-or-update-comment@v3
      with:
        issue-number: ${{ github.event.issue.number }}
        token: ${{ secrets.TOKEN_TO_ADD_COMMENT_TO_ISSUES_PRS }}
        body: |
          Thanks for opening this issue. The ticket [${{ steps.create.outputs.jira-ticket-id }}](https://jira.mongodb.org/browse/${{ steps.create.outputs.jira-ticket-id }}) was created for internal tracking.
