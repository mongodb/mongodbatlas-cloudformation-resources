name: Publish
run-name: Publish ${{ inputs.resourceName }} ${{ inputs.resourceVersionPublishing }} 
on:
  workflow_dispatch:
    inputs:
      regions:
        description: "Stringified JSON array of AWS regions"
        default: '["af-south-1","ap-east-1","ap-northeast-1","ap-northeast-2","ap-northeast-3","ap-south-1","ap-southeast-1","ap-southeast-2","ap-southeast-3","ca-central-1","eu-central-1","eu-north-1","eu-south-1","eu-west-1","eu-west-2","eu-west-3","me-south-1","sa-east-1","us-east-1","us-east-2","us-west-1","us-west-2","ap-south-2","ap-southeast-4","eu-central-2","eu-south-2","me-central-1"]'
        required: true
      resourceName:
        description: "Folder name of the Resource in this Repo"
        default: ""
        required: true
      resourceVersionPublishing:
        description: "Version used to publish the resource, empty will use the next minor version"
        default: ""
        required: false
      maxParallelRegions:
        description: "Maximum number of regions to be updated concurrently"
        type: number
        default: "15"
        required: true
  
jobs:
  compliance:
    runs-on: ubuntu-latest
    steps:
      - name: terraform-provider-mongodbatlas-checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          repository: mongodb/terraform-provider-mongodbatlas
          ref: make-run-script-gha-reusable # TODO: change master
      - name: Generate SSDLC report
        uses: ./.github/templates/run-script-and-commit
        with:
          script_call: |
            make gen-sbom-and-ssdlc-report RESOURCE=${{ github.event.inputs.resourceName }} VERSION=${{ github.event.inputs.resourceVersionPublishing }}
          apix_bot_pat: ${{ secrets.APIX_BOT_PAT }}
          remote: https://svc-apix-bot:${{ secrets.APIX_BOT_PAT }}@github.com/${{ github.repository }}
          gpg_private_key: ${{ secrets.APIX_BOT_GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.APIX_BOT_PASSPHRASE }}
          file_to_commit: 'cfn-resources/${{ github.event.inputs.resourceName }}/compliance/v*/*'
          commit_message:
            "chore: Update SSDLC report for ${{ github.event.inputs.resourceVersionPublishing }}"
          repo-path: "cfn-resources/"
        env:
          KONDUKTO_TOKEN: ${{ secrets.KONDUKTO_TOKEN }}
          SILKBOMB_IMG: ${{ vars.SILKBOMB_IMG }}
          KONDUKTO_REPO: ${{ vars.KONDUKTO_REPO }}
          KONDUKTO_BRANCH_PREFIX: ${{ vars.KONDUKTO_BRANCH_PREFIX }}
