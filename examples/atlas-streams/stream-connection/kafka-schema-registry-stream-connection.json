{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "This template creates a Kafka connection with Schema Registry integration for a stream workspace",
  "Parameters": {
    "Profile": {
      "Type": "String",
      "Default": "default",
      "Description": "Secret Manager Profile that contains the Atlas Programmatic keys"
    },
    "ProjectId": {
      "Type": "String",
      "Description": "Atlas Project Id",
      "MinLength": 24,
      "MaxLength": 24,
      "AllowedPattern": "^([a-f0-9]{24})$"
    },
    "WorkspaceName": {
      "Type": "String",
      "Description": "Human-readable label that identifies the stream workspace"
    },
    "ConnectionName": {
      "Type": "String",
      "Description": "Human-readable label that identifies the stream connection",
      "Default": "KafkaSchemaRegistryConnection"
    },
    "BootstrapServers": {
      "Type": "String",
      "Description": "Comma separated list of Kafka broker addresses"
    },
    "AuthMechanism": {
      "Type": "String",
      "Description": "Style of authentication for Kafka. Can be one of PLAIN, SCRAM-256, or SCRAM-512",
      "Default": "PLAIN",
      "AllowedValues": ["PLAIN", "SCRAM-256", "SCRAM-512"]
    },
    "AuthUsername": {
      "Type": "String",
      "Description": "Username for Kafka cluster authentication"
    },
    "AuthPassword": {
      "Type": "String",
      "Description": "Password for Kafka cluster authentication. Review [AWS security best practices for CloudFormation](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/security-best-practices.html#creds) to manage credentials.",
      "NoEcho": true
    },
    "SecurityProtocol": {
      "Type": "String",
      "Description": "Transport security protocol for Kafka connection",
      "Default": "SSL",
      "AllowedValues": ["PLAINTEXT", "SSL"]
    },
    "SchemaRegistryProvider": {
      "Type": "String",
      "Description": "Schema Registry provider (e.g., 'Confluent', 'AWS', 'Azure')",
      "Default": "Confluent"
    },
    "SchemaRegistryUrl": {
      "Type": "String",
      "Description": "Schema Registry endpoint URL (e.g., 'https://psrc-xxxxx.us-east-2.aws.confluent.cloud')"
    },
    "SchemaRegistryAuthType": {
      "Type": "String",
      "Description": "Authentication type for Schema Registry",
      "Default": "BASIC",
      "AllowedValues": ["BASIC"]
    },
    "SchemaRegistryUsername": {
      "Type": "String",
      "Description": "Username or API Key for Schema Registry authentication"
    },
    "SchemaRegistryPassword": {
      "Type": "String",
      "Description": "Password or API Secret for Schema Registry authentication. Review [AWS security best practices for CloudFormation](https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/security-best-practices.html#creds) to manage credentials.",
      "NoEcho": true
    }
  },
  "Mappings": {},
  "Resources": {
    "StreamConnection": {
      "Type": "MongoDB::Atlas::StreamConnection",
      "Properties": {
        "ProjectId": {
          "Ref": "ProjectId"
        },
        "Profile": {
          "Ref": "Profile"
        },
        "ConnectionName": {
          "Ref": "ConnectionName"
        },
        "WorkspaceName": {
          "Ref": "WorkspaceName"
        },
        "Type": "Kafka",
        "BootstrapServers": {
          "Ref": "BootstrapServers"
        },
        "Authentication": {
          "Mechanism": {
            "Ref": "AuthMechanism"
          },
          "Username": {
            "Ref": "AuthUsername"
          },
          "Password": {
            "Ref": "AuthPassword"
          }
        },
        "Security": {
          "Protocol": {
            "Ref": "SecurityProtocol"
          }
        },
        "Networking": {
          "Access": {
            "Type": "PUBLIC"
          }
        },
        "Provider": {
          "Ref": "SchemaRegistryProvider"
        },
        "SchemaRegistryUrls": [
          {
            "Ref": "SchemaRegistryUrl"
          }
        ],
        "SchemaRegistryAuthentication": {
          "Type": {
            "Ref": "SchemaRegistryAuthType"
          },
          "Username": {
            "Ref": "SchemaRegistryUsername"
          },
          "Password": {
            "Ref": "SchemaRegistryPassword"
          }
        }
      }
    }
  },
  "Outputs": {
    "ConnectionName": {
      "Description": "Name of the created stream connection",
      "Value": {
        "Ref": "ConnectionName"
      }
    },
    "ConnectionType": {
      "Description": "Type of the stream connection",
      "Value": "Kafka"
    },
    "SchemaRegistryProvider": {
      "Description": "Schema Registry provider",
      "Value": {
        "Ref": "SchemaRegistryProvider"
      }
    },
    "SchemaRegistryUrl": {
      "Description": "Schema Registry endpoint URL",
      "Value": {
        "Ref": "SchemaRegistryUrl"
      }
    }
  }
}
