{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "This template creates an advanced Search Index with TypeSets, DynamicConfig, custom analyzers, and static field mappings on the MongoDB Atlas API",
  "Parameters": {
    "ProjectId": {
      "Type": "String",
      "Description": "Project Id"
    },
    "ClusterName": {
      "Type": "String",
      "Description": "Cluster name"
    },
    "DatabaseName": {
      "Type": "String",
      "Description": "Database name"
    },
    "CollectionName": {
      "Type": "String",
      "Description": "Collection name"
    },
    "IndexName": {
      "Type": "String",
      "Description": "Index name"
    },
    "Profile": {
      "Type": "String",
      "Default": "default",
      "Description": "Secret Manager Profile that contains the Atlas Programmatic keys"
    },
    "Analyzer": {
      "Type": "String",
      "Default": "lucene.standard",
      "Description": "Default analyzer for the index"
    },
    "SearchAnalyzer": {
      "Type": "String",
      "Default": "lucene.standard",
      "Description": "Analyzer to use for querying"
    },
    "DynamicConfig": {
      "Type": "String",
      "Default": "{\"typeSet\": \"customTypes\"}",
      "Description": "Dynamic mapping configuration with typeSet reference"
    },
    "Fields": {
      "Type": "String",
      "Default": "{\"property_type\": {\"type\": \"string\"}, \"bedrooms\": {\"type\": \"number\"}}",
      "Description": "Static field mappings"
    },
    "TypeSetName": {
      "Type": "String",
      "Default": "customTypes",
      "Description": "Name for the custom type set"
    },
    "TypeSetTypes": {
      "Type": "String",
      "Default": "[{\"type\": \"string\", \"analyzer\": \"lucene.standard\"}, {\"type\": \"number\"}, {\"type\": \"date\"}]",
      "Description": "Array of types for the type set"
    },
    "AnalyzerName": {
      "Type": "String",
      "Default": "customAnalyzer",
      "Description": "Name for custom analyzer"
    },
    "TokenizerType": {
      "Type": "String",
      "Default": "standard",
      "Description": "Tokenizer type"
    },
    "MaxTokenLength": {
      "Type": "Number",
      "Default": 255,
      "Description": "Maximum token length for tokenizer"
    },
    "StoredSource": {
      "Type": "String",
      "Default": "{\"exclude\": [\"internal_id\"]}",
      "Description": "Stored source configuration"
    },
    "NumPartitions": {
      "Type": "Number",
      "Default": 1,
      "Description": "Number of partitions for the index"
    }
  },
  "Resources": {
    "MySearchIndex": {
      "Type": "MongoDB::Atlas::SearchIndex",
      "Properties": {
        "Analyzer": {
          "Ref": "Analyzer"
        },
        "SearchAnalyzer": {
          "Ref": "SearchAnalyzer"
        },
        "Profile": {
          "Ref": "Profile"
        },
        "ClusterName": {
          "Ref": "ClusterName"
        },
        "CollectionName": {
          "Ref": "CollectionName"
        },
        "Database": {
          "Ref": "DatabaseName"
        },
        "ProjectId": {
          "Ref": "ProjectId"
        },
        "Name": {
          "Ref": "IndexName"
        },
        "Mappings": {
          "DynamicConfig": {
            "Ref": "DynamicConfig"
          },
          "Fields": {
            "Ref": "Fields"
          }
        },
        "Analyzers": [
          {
            "CharFilters": [
              "{\"type\": \"icuNormalize\"}"
            ],
            "Name": {
              "Ref": "AnalyzerName"
            },
            "TokenFilters": [
              "{\"type\": \"asciiFolding\"}",
              "{\"type\": \"lowercase\"}"
            ],
            "Tokenizer": {
              "Type": {
                "Ref": "TokenizerType"
              },
              "MaxTokenLength": {
                "Ref": "MaxTokenLength"
              }
            }
          }
        ],
        "TypeSets": [
          {
            "Name": {
              "Ref": "TypeSetName"
            },
            "Types": {
              "Ref": "TypeSetTypes"
            }
          }
        ],
        "StoredSource": {
          "Ref": "StoredSource"
        },
        "NumPartitions": {
          "Ref": "NumPartitions"
        }
      }
    }
  }
}
